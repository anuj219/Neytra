<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Neytra Mobile Client</title>

  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 10px;
      background: #111;
      color: #fff;
      text-align: center;
    }

    video {
      width: 100%;
      max-width: 400px;
      border-radius: 10px;
    }

    #output {
      margin-top: 15px;
      padding: 10px;
      background: #222;
      border-radius: 10px;
      min-height: 60px;
    }

    button {
      padding: 12px 20px;
      margin: 10px;
      border: none;
      border-radius: 10px;
      /* background: #4CAF50; */
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    button:active {
      background: #45a049;
    }
  </style>
</head>
<body>

<h2>ðŸ‘“ Neytra â€” Smart Glasses Simulation</h2>

<video id="cam" autoplay playsinline></video>

<div id="output">Waiting for frames...</div>

<button id="toggleBtn">Start Streaming</button>

<script>
const backendURL = "http://192.168.29.118:8000";

let streaming = false;
let intervalId = null;

const video = document.getElementById("cam");
const output = document.getElementById("output");

// ---------- 1. Access phone camera (FRONT for now) ----------
async function startCamera() {
  try {
    const constraints = {
      video: { facingMode: { ideal: "user" } }, // front/selfie camera
      audio: false,
    };

    const stream = await navigator.mediaDevices.getUserMedia(constraints);
    video.srcObject = stream;
  } catch (err) {
    output.innerText = "Camera Error: " + err;
  }
}

startCamera();

// ---------- 2. Capture + send frame ----------
async function sendFrame() {
  if (!streaming) return;

  const canvas = document.createElement("canvas");
  canvas.width = 640;
  canvas.height = 480;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

  const blob = await new Promise((resolve) =>
    canvas.toBlob(resolve, "image/jpeg", 0.6)
  );

  const formData = new FormData();
  formData.append("file", blob, "frame.jpg");

  try {
    const res = await fetch(`${backendURL}/frame`, {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    console.log("Data received: "+data.results);
    handleDetection(data.results);
  } catch (err) {
    output.innerText = "Connection Error: " + err;
  }
}

// ---------- 3. Handle detection JSON ----------
function handleDetection(results) {
  if (!results || results.length === 0) {
    output.innerHTML = "No detections.";
    return;
  }

  const FRAME_WIDTH = 640; // must match capture width
  const center = FRAME_WIDTH / 2;
  const margin = FRAME_WIDTH * 0.2;

  function getPosition(bbox) {
    if (!bbox || bbox.length < 4) return "ahead";
    const [x1, , x2] = bbox;
    const cx = (x1 + x2) / 2;
    if (cx < center - margin) return "on your left";
    if (cx > center + margin) return "on your right";
    return "ahead";
  }

  let text = "";
  const phrases = [];

  results.forEach((r) => {
    const pos = getPosition(r.bbox);

    if (r.type === "face") {
      if (r.name === "unknown") {
        text += `ðŸ‘¤ Unknown person (${pos})<br>`;
        phrases.push(`Unknown person ${pos}`);
      } else {
        text += `ðŸŸ¢ ${r.name} (${pos})<br>`;
        if (r.announce) {
          phrases.push(`${r.name} ${pos}`);
        }
      }
    } else if (r.type === "object") {
      text += `ðŸ“¦ ${r.label} (${pos})<br>`;
      phrases.push(`${r.label} ${pos}`);
    }
  });

  output.innerHTML = text || "No detections.";

  if (phrases.length > 0) {
    const sentence = phrases.join(", ");
    speak(sentence);
  }
}

// ---------- 4. Text-to-Speech ----------
function speak(text) {
  const msg = new SpeechSynthesisUtterance(text);
  msg.rate = 1.0;
  msg.pitch = 1.0;
  msg.volume = 1.0;
  window.speechSynthesis.speak(msg);
}

// ---------- 5. Streaming toggle ----------
document.getElementById("toggleBtn").onclick = () => {
  streaming = !streaming;

  if (streaming) {
    intervalId = setInterval(sendFrame, 400); // ~2.5 FPS
    output.innerText = "Streaming startedâ€¦";
    document.getElementById("toggleBtn").innerText = "Stop Streaming";
  } else {
    clearInterval(intervalId);
    output.innerText = "Streaming stopped.";
    document.getElementById("toggleBtn").innerText = "Start Streaming";
  }
};

</script>
</body>
</html>
